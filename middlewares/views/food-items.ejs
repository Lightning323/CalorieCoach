<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Food Items</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<%- include('partials/header.ejs') %>

<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Food Items</h2>
    <button class="btn btn-success" id="addFoodBtn">
      ‚ûï Add Food
    </button>
  </div>

  <table class="table table-striped align-middle">
    <thead>
      <tr>
        <th>Name</th>
        <th>Quantity</th>
        <th>Calories</th>
        <th style="width: 160px">Actions</th>
      </tr>
    </thead>

    <tbody>
      <% if (foods.length === 0) { %>
        <tr>
          <td colspan="4" class="text-center text-muted">
            No food items yet üçΩÔ∏è
          </td>
        </tr>
      <% } %>

      <% foods.forEach(food => { %>
        <tr data-id="<%= food._id %>">
          <td class="food-name"><%= food.name %></td>
          <td class="food-quantity"><%= food.quantity %></td>
          <td class="food-calories"><%= food.calories %></td>
          <td>
            <button class="btn btn-sm btn-primary edit-btn">Edit</button>
            <button class="btn btn-sm btn-danger delete-btn">Delete</button>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal fade" id="foodModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="foodForm" class="modal-content">
      <input type="hidden" id="foodId">

      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Add Food</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Food Name</label>
          <input id="foodName" class="form-control" required />
        </div>

        <div class="mb-3">
          <label class="form-label">Quantity</label>
          <input id="foodQuantity" class="form-control" required />
        </div>

        <div class="mb-3">
          <label class="form-label">Calories</label>
          <input id="foodCalories" type="number" class="form-control" required />
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Save</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const modal = new bootstrap.Modal(document.getElementById("foodModal"));
  const form = document.getElementById("foodForm");

  const foodId = document.getElementById("foodId");
  const nameInput = document.getElementById("foodName");
  const quantityInput = document.getElementById("foodQuantity");
  const caloriesInput = document.getElementById("foodCalories");
  const modalTitle = document.getElementById("modalTitle");

  // Reset modal for ADD
  document.getElementById("addFoodBtn").addEventListener("click", () => {
    form.reset();
    foodId.value = "";
    modalTitle.innerText = "Add Food";
    modal.show();
  });

  // Edit buttons
  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const row = btn.closest("tr");

      foodId.value = row.dataset.id;
      nameInput.value = row.querySelector(".food-name").innerText;
      quantityInput.value = row.querySelector(".food-quantity").innerText;
      caloriesInput.value = row.querySelector(".food-calories").innerText;

      modalTitle.innerText = "Edit Food";
      modal.show();
    });
  });

  // Delete buttons
  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const row = btn.closest("tr");
      const id = row.dataset.id;

      if (!confirm("Delete this food item?")) return;

      const res = await fetch(`/api/foods/${id}`, { method: "DELETE" });
      if (res.ok) location.reload();
      else alert("Failed to delete food");
    });
  });

  // Submit (Add or Edit)
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const food = {
      name: nameInput.value,
      quantity: quantityInput.value,
      calories: Number(caloriesInput.value),
    };

    const id = foodId.value;
    const url = id ? `/api/foods/${id}` : "/api/foods";
    const method = id ? "PUT" : "POST";

    const res = await fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(food),
    });

    if (res.ok) location.reload();
    else alert("Failed to save food");
  });
});
</script>

</body>
</html>
