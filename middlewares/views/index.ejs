<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head.ejs') %>
  <title>CalorieCoach - Dashboard</title>
</head>
<body>

<%- include('partials/header.ejs') %>

<div id="loadingOverlay" class="d-flex d-none">
  <div>‚è≥ Logging food, please wait...</div>
</div>

<div class="container my-4">
  <h2 class="mb-3">Daily Consumption</h2>

  <% 
    const totalCalories = todayFoods.reduce((sum, f) => sum + f.foodItem.calories * f.quantity, 0);
    const percent = Math.min((totalCalories / calorieGoal) * 100, 100);
    const overGoal = totalCalories > calorieGoal;
  %>
  <%
function pluralize(quantity, unit) {
  // Try to detect if quantity > 1 and pluralize basic units
  const words = unit.split(' '); // e.g., ["1", "cup"]
  if (words.length === 2 && !isNaN(parseFloat(words[0]))) {
    let num = parseFloat(words[0]) * quantity;
    let unitWord = words[1];

    // Very simple pluralization
    if (num > 1) {
      if (unitWord.endsWith('ch')) unitWord += 'es';
      else if (unitWord.endsWith('y')) unitWord = unitWord.slice(0, -1) + 'ies';
      else unitWord += 's';
    }

    return `${num} ${unitWord}`;
  }
  // fallback
  return `${quantity} ${unit}`;
}
%>

  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <strong><%= totalCalories %> / <%= calorieGoal %> kcal</strong>
      <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#goalModal">
        Change Goal
      </button>
    </div>

    <div class="progress" style="height: 25px;">
      <div
        class="progress-bar <%= overGoal ? 'bg-danger' : 'bg-success' %>"
        role="progressbar"
        style="width: <%= percent %>%"
      >
        <%= totalCalories %> / <%= calorieGoal %> kcal
      </div>
    </div>

    <% if (overGoal) { %>
      <div class="text-danger mt-1">üö® You are over your calorie goal!</div>
    <% } %>
  </div>

  <h3>Log Food</h3>
  <form id="logFoodForm" class="mb-4" action="/log-food" method="POST">
    <div class="mb-2">
      <textarea name="foodItems" class="form-control" placeholder="Describe the food types / quantities (multiple items allowed)" required></textarea>
    </div>
    <button id="logFoodBtn" class="btn btn-primary w-100">Log</button>
  </form>

  <h3>Logged Today</h3>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Food</th>
        <th>Quantity</th>
        <th>Calories</th>
        <!-- <th>Notes</th> -->
        <th></th>
      </tr>
    </thead>
    <tbody>
      <% if (todayFoods.length === 0) { %>
        <tr>
          <td colspan="5" class="text-center text-muted">No foods logged yet üçΩÔ∏è</td>
        </tr>
      <% } %>

      <% todayFoods.forEach(food => { %>
        <tr>
          <td><%= food.foodItem.name %></td>
          <td><%= pluralize(food.quantity, food.foodItem.quantity) %></td>
          <td><%= food.foodItem.calories * food.quantity %></td>
          <!-- <td><%= food.notes %></td> -->
          <td>
            <button 
              class="btn btn-sm btn-info me-1 editFoodBtn"
              data-log-id="<%= food._id %>"
              data-log-date="<%= food.logDate %>"
              data-food-name="<%= food.foodItem.name %>"
              data-food-quantity="<%= food.foodItem.quantity %>"
              data-food-calories="<%= food.foodItem.calories %>"

              data-quantity="<%= food.quantity %>"
              data-notes="<%= food.notes %>"
            ><i class="fa fa-info"></i></button>
            <form action="/delete-food" method="POST" class="d-inline">
              <input type="hidden" name="foodLogId" value="<%= food._id %>">
              <button class="btn btn-sm btn-danger"><i class="fa fa-trash"></i></button>
            </form>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<!-- Edit Food Modal -->
<div class="modal fade" id="editFoodModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="editFoodForm" action="/edit-day-food" method="POST">
     <input type="hidden" name="foodLogId" id="editFoodId">
      <div class="modal-header">
        <h5 class="modal-title">Edit Food</h5>
        <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <p>Entry (<span id="loggedAt" ></span>)</label>
          <p class="form-control" id="foodEntry" ></p>
        </div>
        <div class="mb-3">
          <label>Quantity</label>
          <input class="form-control" name="quantity" id="editFoodQuantity" type="number" step="any">
        </div>
        <div class="mb-3">
          <label>Notes</label>
          <textarea class="form-control" id="editFoodNotes" readonly></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Change Calorie Goal Modal -->
<div class="modal fade" id="goalModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" action="/calorie-goal" method="POST">
      <div class="modal-header">
        <h5 class="modal-title">Change Calorie Goal</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input name="calorieGoal" type="number" class="form-control" value="<%= calorieGoal %>" required />
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success">Save</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const loadingOverlay = document.getElementById("loadingOverlay");
const logFoodForm = document.getElementById("logFoodForm");

function displayLoadingOverlay() {
  console.log("Displaying loading overlay");
  loadingOverlay.classList.remove('d-none');
}

if (logFoodForm) {
  logFoodForm.addEventListener("submit", () => {
    displayLoadingOverlay();
  });
}

// Edit Food Modal
const editModal = new bootstrap.Modal(document.getElementById("editFoodModal"));
document.querySelectorAll(".editFoodBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.getElementById("editFoodId").value = btn.dataset.logId;

    document.getElementById("foodEntry").innerHTML = btn.dataset.foodName
      + "<br>(" + btn.dataset.foodCalories + " kcal / " + btn.dataset.foodQuantity + ")";

    document.getElementById("loggedAt").innerHTML = new Date(btn.dataset.logDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })


    document.getElementById("editFoodQuantity").value = btn.dataset.quantity;
    document.getElementById("editFoodNotes").value = btn.dataset.notes;
    editModal.show();
  });
});

</script>
</body>
</html>
