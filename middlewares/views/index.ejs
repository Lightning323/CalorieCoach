<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CalorieCoach Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #loadingOverlay {
      display: none ! important;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1050;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 1.5rem;
    }
  </style>
</head>
<body>

<%- include('partials/header.ejs') %>

<div id="loadingOverlay" class="d-flex">
  <div>
    ‚è≥ Logging food, please wait...
  </div>
</div>

<div class="container my-4">
  <h2 class="mb-3">Daily Consumption</h2>

  <% 
    const totalCalories = todayFoods.reduce((sum, f) => sum + f.calories, 0);
    const percent = Math.min((totalCalories / calorieGoal) * 100, 100);
    const overGoal = totalCalories > calorieGoal;
  %>

  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <strong>Calorie Goal: <%= calorieGoal %> kcal</strong>
      <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#goalModal">
        Change Goal
      </button>
    </div>

    <div class="progress" style="height: 25px;">
      <div
        class="progress-bar <%= overGoal ? 'bg-danger' : 'bg-success' %>"
        role="progressbar"
        style="width: <%= percent %>%"
      >
        <%= totalCalories %> / <%= calorieGoal %> kcal
      </div>
    </div>

    <% if (overGoal) { %>
      <div class="text-danger mt-1">
        üö® You are over your calorie goal!
      </div>
    <% } %>
  </div>

  <h3>Log Food</h3>

  <form id="logFoodForm" class="row g-2 mb-4" action="/log-food" method="POST">
    <div class="col-md-6">
      <input name="name" class="form-control" placeholder="Food name" required>
    </div>
    <div class="col-md-4">
      <input name="quantity" class="form-control" placeholder="Quantity (e.g., 1 cup, 1 medium)" required>
    </div>
    <div class="col-md-2">
      <button id="logFoodBtn" class="btn btn-primary w-100">Log</button>
    </div>
  </form>

  <h3>Logged Today</h3>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>Food</th>
        <th>Quantity</th>
        <th>Calories</th>
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      <% if (todayFoods.length === 0) { %>
        <tr>
          <td colspan="4" class="text-center text-muted">
            No foods logged yet üçΩÔ∏è
          </td>
        </tr>
      <% } %>

      <% todayFoods.forEach(food => { %>
        <tr>
          <td><%= food.name %></td>
          <td><%= food.quantity %></td>
          <td><%= food.calories %></td>
          <td>
            <button class="btn btn-sm btn-info me-1 editFoodBtn"
              data-food-id="<%= food._id %>"
              data-name="<%= food.name %>"
              data-quantity="<%= food.quantity %>"
              data-calories="<%= food.calories %>"
              data-description="<%= food.aiDescription || '' %>"
            >Edit / Info</button>
            <form action="/delete-food" method="POST" class="d-inline">
              <input type="hidden" name="foodId" value="<%= food._id %>">
              <button class="btn btn-sm btn-danger">Remove</button>
            </form>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<!-- Edit Food Modal -->
<div class="modal fade" id="editFoodModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="editFoodForm" action="/edit-day-food" method="POST">
      <input type="hidden" name="foodId" id="editFoodId">
      <div class="modal-header">
        <h5 class="modal-title">Edit Food</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label>Name</label>
          <input class="form-control" name="name" id="editFoodName">
        </div>
        <div class="mb-3">
          <label>Quantity</label>
          <input class="form-control" name="quantity" id="editFoodQuantity">
        </div>
        <div class="mb-3">
          <label>Calories</label>
          <input class="form-control" name="calories" id="editFoodCalories" type="number">
        </div>
        <div class="mb-3">
          <label>AI Description</label>
          <textarea class="form-control" id="editFoodDescription" readonly></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Change Calorie Goal Modal -->
<div class="modal fade" id="goalModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" action="/calorie-goal" method="POST">
      <div class="modal-header">
        <h5 class="modal-title">Change Calorie Goal</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input
          name="calorieGoal"
          type="number"
          class="form-control"
          value="<%= calorieGoal %>"
          required
        />
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success">Save</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const loadingOverlay = document.getElementById("loadingOverlay");
  const logFoodForm = document.getElementById("logFoodForm");

  // Ensure overlay is hidden initially
  if (loadingOverlay) loadingOverlay.style.display = "none";

  if (logFoodForm) {
    logFoodForm.addEventListener("submit", () => {
      if (loadingOverlay) loadingOverlay.style.display = "flex";
    });
  }

  // Edit Food Modal
  const editModal = new bootstrap.Modal(document.getElementById("editFoodModal"));
  document.querySelectorAll(".editFoodBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.getElementById("editFoodId").value = btn.dataset.foodId;
      document.getElementById("editFoodName").value = btn.dataset.name;
      document.getElementById("editFoodQuantity").value = btn.dataset.quantity;
      document.getElementById("editFoodCalories").value = btn.dataset.calories;
      document.getElementById("editFoodDescription").value = btn.dataset.description || '';
      editModal.show();
    });
  });
});
</script>

</body>
</html>
