<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head.ejs') %>
  <title>CalorieCoach - Dashboard</title>
  <style>
    #historyToggle[aria-expanded="true"] i {
  transform: rotate(180deg);
}

#historyToggle i {
  transition: transform 0.3s ease;
}

#consumptionToggleable{
  cursor: pointer;
  color:gray;
}

#consumptionToggleable:hover{
color:black;
}

  </style>
</head>
<body>
 <% 
    const totalCalories = todayFoods.reduce((sum, f) => sum + (f.foodItem ? f.foodItem.calories * f.quantity : 0), 0);
    const percent = Math.min((totalCalories / calorieGoal) * 100, 100);
    const overGoal = totalCalories > calorieGoal;

    function pluralize(quantity, unit) {
      if (!unit) return `${quantity}`;
      const words = unit.split(' ');
      let unitWord = null;
      if(words.length > 1) unitWord = words.slice(1).join(" ");

      if (unitWord && !isNaN(parseFloat(words[0]))) {
        let num = parseFloat(words[0]) * quantity;
        

        if (num > 1) {
          if (unitWord.endsWith('ch')) unitWord += 'es';
          else if (unitWord.endsWith('y')) unitWord = unitWord.slice(0, -1) + 'ies';
          else if(!unitWord.endsWith('s')) unitWord += 's';
        }

        return `${num} ${unitWord}`;
      }else if( !isNaN(parseFloat(unit)) ){
        var val =  parseFloat(unit) * quantity;
        if(unitWord){
          return `${val} ${words[1]}`
        }else{
          return `${val}`
        }
        
      }
      return `${quantity} ${unit}`;
    }
    
    %>

<%- include('partials/header.ejs') %>

<div id="loadingOverlay" class="d-flex d-none">
  <div><i class="fa fa-spinner fa-spin"></i> Logging food, please wait...</div>
</div>

<div class="container my-4">
  <h2 class="mb-3">Consumption</h2>
 
  <div class="card p-3 shadow-sm mb-4">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <strong><%= Math.round(totalCalories) %> / <%= Math.round(calorieGoal) %> kcal</strong>
      <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#goalModal">
        Change Goal
      </button>
    </div>

    <div
      data-bs-toggle="collapse"
      data-bs-target="#historyDiv"
      id="consumptionToggleable"
    >


    <div class="progress" style="height: 25px;">
      <div
        class="progress-bar <%= overGoal ? 'bg-danger' : 'bg-success' %>"
        role="progressbar"
        style="width: <%= percent %>%" >
        <%= Math.round(totalCalories) %> / <%= Math.round(calorieGoal) %> kcal
      </div>
    </div>

<% if (overGoal) { %>
  <div class="text-danger mt-1 text-center">
   <i class="fa-solid fa-triangle-exclamation"></i><strong><%= Math.round(totalCalories-calorieGoal) %></strong> kcal over your limit
  </div>
<% } else { %>
  <div class="text-success mt-1 text-center">
    <i class="fa fa-fire"></i> <strong><%= Math.round(calorieGoal - totalCalories) %></strong> kcal remaining
  </div>
<% } %>
    <div 
      style="text-align: center; margin-top: 10px;"
  data-bs-toggle="collapse"
  data-bs-target="#historyDiv"
  aria-expanded="false"
  id="historyToggle"
    >
    <i class="fa fa-chevron-down" ></i>
    </div>
    </div>


<div class="collapse mt-3" id="historyDiv">
  <div >
    <h5 class="mb-3"><i class="fa fa-history"></i> Calorie History</h5>

  
    <% if (calorieHistory && calorieHistory.length > 0) { %>

<%
  const last7Days = calorieHistory.slice(-7);
  const daysCount = last7Days.length; // actual days recorded

  const totalCaloriesThisWeek = last7Days.reduce(
    (sum, c) => sum + c,
    0
  );

  const weeklyDelta = totalCaloriesThisWeek - (calorieGoal * daysCount);
%>

  <!-- This week: <%= Math.round(totalCaloriesThisWeek) %> kcal<br> -->
<% if (weeklyDelta > 0) { %>
    <p class="text-danger">(<i class="fa-solid fa-triangle-exclamation"></i><%= Math.round(weeklyDelta) %> kcal over your weekly limit)</p>
<% } else { %>
    <p class="text-success">(<i class="fa fa-fire"></i><%= Math.round(Math.abs(weeklyDelta)) %> kcal under your weekly limit)</p>
<% } %>




      <ul class="list-group">
        <% 
          const len = calorieHistory.length;
          for (let i = len - 1; i >= 0; i--) {
            const daysAgo = len - i;
        %>
          <li class="list-group-item d-flex justify-content-between">
            <span>
              <%= daysAgo === 1 
                  ? "Yesterday" 
                  : `${daysAgo} days ago` %>
            </span>
            <strong class="text-<%= calorieHistory[i] > calorieGoal ? 'danger' : 'success' %>" ><%= calorieHistory[i] %> kcal     
            </strong>
           
            <% if(calorieHistory[i] > calorieGoal) { %>
              <span class="text-danger">
            (<i class="fa-solid fa-triangle-exclamation"></i> +<%= Math.round(calorieHistory[i]- calorieGoal) %>)</span>
            <% } else { %>
              <span class="text-success">    (-<%= Math.round(calorieGoal - calorieHistory[i]) %>)  </span>
            <% } %>
                
          
          </li>
        <% } %>
      </ul>
    <% } else { %>
      <div class="text-muted text-center">
        No history yet...
      </div>
<% } %>

  </div>
</div>


  </div>

  <h2>Log Food</h2>
<form id="logFoodForm" class="card p-3 shadow-sm mb-4" action="/log-food" method="POST">
  <div class="mb-3">
    <label for="foodItems" class="form-label">
      What did you eat?
    </label>
    <textarea
      id="foodItems"
      name="foodItems"
      class="form-control"
      rows="3"
      placeholder="e.g. 1 cup strawberry lemonade, 2 bananas, 1 snickers bar"
      required
    ></textarea>
  </div>

  <div class="form-check mb-3">
    <input
      class="form-check-input"
      type="checkbox"
      name="simpleAI"
      id="simpleAI"
      value="true"
      checked
    />
    <label class="form-check-label" for="simpleAI">
      Use simple AI (faster, fewer checks)
    </label>
  </div>

  <button
    id="logFoodBtn"
    class="btn btn-primary w-100 fw-semibold"
    type="submit"
  >
    Log Food
  </button>
</form>


  <h2>Logged Today</h2>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Food</th>
        <th>Quantity</th>
        <th>Calories</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <% if (todayFoods.length === 0) { %>
        <tr>
          <td colspan="4" class="text-center text-muted">No foods logged yet üçΩÔ∏è</td>
        </tr>
      <% } %>

      <% todayFoods.forEach(food => { %>
        <% if (food.foodItem) { %>
          <tr>
            <td><%= food.foodItem.name %></td>
            <td><%= pluralize(food.quantity, food.foodItem.quantity) %></td>
            <td><%= Math.round(food.foodItem.calories * food.quantity) %></td>
            <td>
              <button 
                class="btn btn-sm btn-info editFoodBtn"
                data-log-id="<%= food._id %>"
                data-log-date="<%= food.logDate %>"
                data-food-name="<%= food.foodItem.name %>"
                data-food-quantity="<%= food.foodItem.quantity %>"
                data-food-calories="<%= food.foodItem.calories %>"
                data-quantity="<%= food.quantity %>"
                data-notes="<%= food.notes %>"
              ><i class="fa fa-info"></i></button>
            </td>
          </tr>
        <% } else { %>
          <tr class="text-muted">
            <td colspan="4">‚ö†Ô∏è This food entry no longer exists</td>
          </tr>
        <% } %>
      <% }) %>
    </tbody>
  </table>
</div>

<!-- Edit Food Modal -->
<div class="modal fade" id="editFoodModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="editFoodForm" action="/edit-day-food" method="POST">
      <input type="hidden" name="foodLogId" id="editFoodId">
      <div class="modal-header">
        <h5 class="modal-title">Edit Food</h5>
        <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <p>Entry (<span id="loggedAt"></span>)</p>
          <p class="form-control" id="foodEntry"></p>
        </div>
        <div class="mb-3">
          <label>Quantity</label>
          <input class="form-control" name="quantity" id="editFoodQuantity" type="number" step="any">
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button type="button" class="btn btn-danger" id="deleteFoodBtn"><i class="fa fa-trash"></i> Delete</button>
        <div>
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" type="submit">Save</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Change Calorie Goal Modal -->
<div class="modal fade" id="goalModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" action="/calorie-goal" method="POST">
      <div class="modal-header">
        <h5 class="modal-title">Change Calorie Goal</h5>
        <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input name="calorieGoal" type="number" class="form-control" value="<%= calorieGoal %>" required />
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
        <button class="btn btn-success">Save</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const loadingOverlay = document.getElementById("loadingOverlay");
const logFoodForm = document.getElementById("logFoodForm");

function displayLoadingOverlay() {
  console.log("Displaying loading overlay");
  loadingOverlay.classList.remove('d-none');
}

if (logFoodForm) {
  logFoodForm.addEventListener("submit", () => {
    displayLoadingOverlay();
  });
}

// Edit Food Modal
const editModal = new bootstrap.Modal(document.getElementById("editFoodModal"));

document.querySelectorAll(".editFoodBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    if (!btn.dataset.foodName) return alert("This food entry no longer exists.");

    const logId = btn.dataset.logId;
    document.getElementById("editFoodId").value = logId;

    document.getElementById("foodEntry").innerHTML = btn.dataset.foodName
      + "<br>(" + btn.dataset.foodCalories + " kcal / " + btn.dataset.foodQuantity + ")";
    
    document.getElementById("loggedAt").innerHTML = new Date(btn.dataset.logDate)
      .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    document.getElementById("editFoodQuantity").value = btn.dataset.quantity;
    //document.getElementById("editFoodNotes").value = btn.dataset.notes;

    editModal.show();
  });
});

// Delete button
document.getElementById("deleteFoodBtn").addEventListener("click", () => {
  const logId = document.getElementById("editFoodId").value;
  if (!logId) return;

  fetch("/delete-food", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ foodLogId: logId })
  }).then(() => location.reload());
});

</script>
</body>
</html>
