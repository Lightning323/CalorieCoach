<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head.ejs') %>
  <title>CalorieCoach - Food Items</title>
</head>
<body>
<%- include('partials/header.ejs') %>



<ul class="nav nav-tabs" id="foodTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <a
    href="/food-items"
      class="nav-link active"
      type="button"
      role="tab"
    > Database
  </a>
    
  </li>
  <li class="nav-item" role="presentation">
    <a
      href="/foodFactsAPI"
      class="nav-link"
      type="button"
      role="tab"
    > Search OpenFoodFacts
  </a>
  </li>
</ul>

<div class="container py-5">
  <div class="justify-content-between align-items-center mb-3">
   <h1 class="mb-4 text-center">Food Items</h1>
    <div class="d-flex">
      <input
        type="text"
        id="foodSearch"
        class="form-control me-2"
        placeholder="Search food..."
      />
      <button class="btn btn-success" id="addFoodBtn" style="min-width: fit-content;">
        <i class="fa fa-plus"></i> Add
      </button>
    </div>
  </div>

  <div style="overflow-x: auto;">
  <table class="table table-striped align-middle">
    <thead>
      <tr>
            <th></th>
        <th>Name</th>
        <th>Quantity</th>
        <th>Nutrition</th>
    
      </tr>
    </thead>
    <tbody id="db_body">
      <% if (foods.length === 0) { %>
        <tr>
          <td colspan="7" class="text-center text-muted">No food items yet</td>
        </tr>
      <% } %>
      <% for (let i = foods.length - 1; i >= 0; i--) {
        const food = foods[i]; %>
        <tr data-id="<%= food._id %>">
                <td>
            <button class="btn btn-sm btn-primary edit-btn"><i class="fa fa-edit"></i></button>
          </td>
          <td class="food-name"><%= food.name %></td>
          <td class="food-quantity"><%= food.quantity %></td>
          <td>
            <span class="food-calories"><%= food.calories %></span> Kcal<br>
            <span class="food-protein"><%= food.protein ?? 0 %></span>g protein<br>
            <span class="food-carbs"><%= food.carbs ?? 0 %></span>g carbs<br>
            <span class="food-fat"><%= food.fat ?? 0 %></span>g fat<br>
            </td>
        </tr>
      <% } %>
    </tbody>
  </table>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="foodModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="foodForm" class="modal-content">
      <input type="hidden" id="foodId">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Add Food</h5>
        <button type="button" type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Food Name</label>
          <input id="foodName" class="form-control" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Quantity</label>
          <input id="foodQuantity" class="form-control" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Calories (Kcal)</label>
          <input id="foodCalories" type="number" class="form-control" required />
        </div>
        <div class="mb-3">
          <label class="form-label">Protein (g)</label>
          <input id="foodProtein" type="number" step="any" class="form-control" />
        </div>
        <div class="mb-3">
          <label class="form-label">Carbs (g)</label>
          <input id="foodCarbs" type="number" step="any" class="form-control" />
        </div>
        <div class="mb-3">
          <label class="form-label">Fat (g)</label>
          <input id="foodFat" type="number" step="any" class="form-control" />
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button class="btn btn-danger" id="deleteFoodBtn" style="display:none;">
          <i class="fa fa-trash"></i> Delete
        </button>
        <div>
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save</button>
        </div>
      </div>
    </form>
  </div>
</div>
<%- include('partials/footer') %>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const modal = new bootstrap.Modal(document.getElementById("foodModal"));
  const form = document.getElementById("foodForm");

  const foodId = document.getElementById("foodId");
  const nameInput = document.getElementById("foodName");
  const quantityInput = document.getElementById("foodQuantity");
  const caloriesInput = document.getElementById("foodCalories");
  const proteinInput = document.getElementById("foodProtein");
  const carbsInput = document.getElementById("foodCarbs");
  const fatInput = document.getElementById("foodFat");
  const modalTitle = document.getElementById("modalTitle");
  const searchInput = document.getElementById("foodSearch");
  const deleteBtn = document.getElementById("deleteFoodBtn");

  // Add Food button
  document.getElementById("addFoodBtn").addEventListener("click", () => {
    form.reset();
    foodId.value = "";
    modalTitle.innerText = "Add Food";
    deleteBtn.style.display = "none"; // hide delete button when adding
    modal.show();
  });

  // Edit buttons
  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.addEventListener("click", () => {
    console.log(btn);
      const row = btn.closest("tr");
      foodId.value = row.dataset.id;
      nameInput.value = row.querySelector(".food-name").innerText;
      quantityInput.value = row.querySelector(".food-quantity").innerText;
      caloriesInput.value = row.querySelector(".food-calories").innerText;
      proteinInput.value = row.querySelector(".food-protein").innerText;
      carbsInput.value = row.querySelector(".food-carbs").innerText;
      fatInput.value = row.querySelector(".food-fat").innerText;
      modalTitle.innerText = "Edit Food";
      deleteBtn.style.display = "inline-block"; // show delete button when editing
      modal.show();
    });
  });

  // Delete button inside modal
  deleteBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    if (!confirm("Delete this food item?")) return;
    const id = foodId.value;
    if (!id) return;
    const res = await fetch(`/api/foods/${id}`, { method: "DELETE" });
    if (res.ok) location.reload();
    else alert("Failed to delete food");
  });

  // Submit form
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const food = {
      name: nameInput.value,
      quantity: quantityInput.value,
      calories: Number(caloriesInput.value),
      protein: proteinInput.value !== "" ? Number(proteinInput.value) : undefined,
      carbs: carbsInput.value !== "" ? Number(carbsInput.value) : undefined,
      fat: fatInput.value !== "" ? Number(fatInput.value) : undefined,
    };
    const id = foodId.value;
    const url = id ? `/api/foods/${id}` : "/api/foods";
    const method = id ? "PUT" : "POST";
    const res = await fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(food),
    });
    if (res.ok) location.reload();
    else alert("Failed to save food");
  });

  // Search filter
  searchInput.addEventListener("input", () => {
    const filter = searchInput.value.toLowerCase();
    document.querySelectorAll("tbody tr").forEach(row => {
      const name = row.querySelector(".food-name").innerText.toLowerCase();
      const quantity = row.querySelector(".food-quantity").innerText.toLowerCase();
      const calories = row.querySelector(".food-calories").innerText.toLowerCase();
      const protein = row.querySelector(".food-protein").innerText.toLowerCase();
      const carbs = row.querySelector(".food-carbs").innerText.toLowerCase();
      const fat = row.querySelector(".food-fat").innerText.toLowerCase();
      row.style.display = (name.includes(filter) || quantity.includes(filter) || calories.includes(filter) || protein.includes(filter) || carbs.includes(filter) || fat.includes(filter)) ? "" : "none";
    });
  });
});
</script>

</body>
</html>
